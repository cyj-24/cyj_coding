---
description: 当用户询问"帮我制定旅行攻略"、"create a travel itinerary"、"plan a trip"、"规划路线"、"make travel攻略"或讨论"旅行攻略"、"旅游计划"、"景点推荐"、"travel planning"、"itinerary creation"时使用此技能。自动从小红书收集旅行信息并整合Google Maps数据生成全面的旅行指南。⚠️ 必须为每个景点获取 Google Maps 链接、评分、地址信息、支付方式和地点图片。
---

# 旅行攻略生成器

**版本: 1.4.0**

通过从小红书提取真实的旅行信息并整合Google Maps数据，生成全面的旅行行程。

## 概述

此技能通过以下方式自动创建详细的旅行指南：

- 搜索并提取小红书的旅行笔记
- ⚠️ 从 Google Maps 收集每个景点的详细信息（必需）
  - Google Maps 链接
  - 评分和评论数
  - 完整地址
  - 营业时间
- 📸 地点图片截图（必需）
- 生成路线地图和地点快照
- 🗺️ 完整路线图截图（必需）
- 将所有内容编译成结构化的 Markdown 行程

### 核心质量保证

- ✅ 每个景点都必须有 Google Maps 数据支撑
- ✅ 每个景点都必须有地点图片
- ✅ 每个餐厅/景点都标注了支付方式（刷卡/现金）
- ✅ 用户可以直接点击链接导航
- ✅ 评分数据帮助决策
- ✅ 地址信息确保可到达性
- ✅ 完整路线图方便概览整个行程

### 依赖要求

- Chrome DevTools MCP 服务器（推荐，用于浏览器自动化）
- 或 Web Search + Web Reader MCP 工具（替代方案）

---

## 1. 收集旅行参数

首先从用户那里收集基本信息。

### 必需参数
- **目的地 (Destination)**: 要访问的城市或地区
- **旅行天数 (Duration)**: 旅行天数

### 可选参数
- **旅行类型 (Trip Type)**: 美食之旅、文化探索、自然探险等
- **预算范围 (Budget)**: 总预算估算
- **出行时间 (Travel Time)**: 旅行计划时间

### 示例对话
- 用户: "帮我制定一个5天的成都美食之旅"
- 收集信息: `destination=成都`, `days=5`, `type=美食之旅`

---

## 2. 搜索小红书

从小红书提取真实的旅行体验和推荐。

### 步骤1: 访问小红书
使用 `navigate_page` 访问 `xiaohongshu.com` 并等待页面加载:
- `navigate_page("https://www.xiaohongshu.com")`
- `wait_for(".search-input", 5000)`

### 步骤2: 搜索旅行笔记
在搜索框中填入目的地和旅行类型:
- `fill(".search-input", "{destination} {trip_type} 攻略")`
- `press_key("Enter")`
- `wait_for(".note-item", 10000)`

### 步骤3: 提取笔记内容
使用 `evaluate_script` 从搜索结果中提取结构化数据:
- 标题、作者、内容文本
- 点赞数、收藏数
- 提到的景点、餐厅、酒店
- 旅行提示和实用信息
- *详细的提取模式，请参考 `references/xiaohongshu-selectors.md`*

### 步骤4: 加载更多结果
向下滚动加载更多笔记:
```python
for i in range(3):
    press_key("End")
    wait_for(2000)
```

### 步骤5: 浏览至少10篇笔记 (必需)
**关键**: 你必须浏览并提取至少10篇相关旅行笔记的内容。不要跳过此步骤或匆忙完成。

1. 点击每篇笔记在搜索结果中
2. 提取完整内容从每篇笔记中:
   - 完整的旅行行程/路线
   - 所有提到的景点、餐厅、酒店
   - 价格和预算信息
   - 实用提示和警告
   - 营业时间和联系信息
   - 个人经验和推荐
3. 返回并继续下一篇笔记:
   - `navigate_page("back")`
   - 等待页面加载
   - 点击下一个笔记链接
4. 重复直到浏览了至少10篇笔记:
   - 重点关注互动量高的笔记（点赞/收藏）
   - 优先选择最近的帖子（最近6个月内）
   - 包含不同视角（美食、文化、预算、奢华）
   - 花时间仔细阅读 - 质量优于速度

#### 追踪你的进度
- 记录浏览的笔记数量
- 记录提到的独特地点
- 记录多篇文章中的共同推荐
- 识别价格范围和预算提示

> [!IMPORTANT]
> ⚠️ 在浏览至少10篇笔记之前不要生成行程
> ⚠️ 即使笔记看起来相似也不要跳过 - 每篇都可能有独特见解
> ⚠️ 最终行程的质量取决于充分的研究
> **时间投入**: 浏览最少需要10-15分钟

### 步骤6: 处理提取的数据
- 按标题和内容相似性去重笔记
- 按点赞数和收藏数排序
- 提取关键地点（景点、餐厅、酒店）
- 识别共同主题和推荐
- 创建所有提到地点的汇总列表

---

## 3. 整合Google Maps (必需步骤)

> [!WARNING]
> ⚠️ **重要**: 每个景点和餐厅都必须通过 Google Maps MCP 搜索获取详细信息。这是生成高质量攻略的必需步骤，不可跳过。

从Google Maps获取详细信息以丰富提取的地点。

### 对于每个地点 (必须执行)

#### 1. 在Google Maps上搜索
- `navigate_page("https://www.google.com/maps")`
- `wait_for(".searchbox", 5000)`
- `fill(".searchbox", "{location_name}")`
- `press_key("Enter")`
- `wait_for(".place-info", 10000)`

#### 2. 提取地点详情 (必需)
使用 `evaluate_script` 检索以下所有信息:
- ✅ **完整地址** (必需)
- ✅ **Google Maps直接链接** (必需)
- ✅ **评分和评论数** (必需)
- ✅ 营业时间
- ✅ 电话号码
- ✅ 网站URL
- ✅ 💳 **支付方式** (是否接受信用卡/借记卡，这是必需信息)

#### 3. 保存地点图片截图 (必需)
- `take_screenshot("./maps/{location_id}.png", fullPage=False)`

**截图要求**:
- ⚠️ 使用Chrome DevTools MCP的 `take_screenshot` 工具
- 截图应包含地点的街景视图、地图标记或地点照片
- 确保截图清晰可见，能识别地点特征
- 图片将嵌入到最终攻略中
- 文件命名格式: `{地点名称英文名或拼音}.png`

> [!NOTE]
> ⚠️ 每个提到的景点都必须在 Google Maps 上搜索
> ⚠️ 必须提取完整的 Google Maps 链接
> ⚠️ 必须提取评分和评论数
> ⚠️ 这些信息必须出现在最终生成的攻略中
> *详细的Google Maps工作流程，请参考 `references/google-maps-workflows.md`*

### 使用 MCP 工具的替代方法
如果 Chrome DevTools MCP 服务器不可用，可以使用以下 MCP 工具：

**Web Search + Web Reader 组合**:
1. 使用 `mcp__web-search-prime__webSearchPrime` 搜索地点信息
2. 使用 `mcp__web_reader__webReader` 获取详细地址和评分信息

*示例流程*:
```python
# 搜索景点信息
search_result = mcp__web-search-prime__webSearchPrime(
    search_query="Tan Dinh Church 胡志明市 评分 地址",
    location="cn"
)

# 从搜索结果中提取 Google Maps 链接
maps_link = extract_google_maps_link(search_result)

# 获取详细信息
details = mcp__web_reader__webReader(
    url=maps_link,
    return_format="markdown"
)
```

---

## 4. 生成路线地图

在多个地点之间创建导航路线:

### 1. 打开Google Maps并规划路线
- `navigate_page("https://www.google.com/maps/dir/")`
- `wait_for(".searchbox", 5000)`

### 2. 添加所有途经点并优化路线 (必需)
- 输入起点位置
- 点击"添加目的地"
- 按地理位置顺序依次添加每个景点，而非随意添加
- 使用Google Maps的"优化路线"功能 (如可用)
- 确保路线最短，避免走回头路
- 考虑景点开放时间，合理安排游览顺序

**路线优化原则**:
- ⚠️ 必须按地理位置相近的原则分组景点
- ⚠️ 同区域的景点安排在同一天/同一时段
- ⚠️ 使用Google Maps查看实际距离，避免绕路
- ⚠️ 优先考虑步行可达的路线顺序
- ⚠️ 必要时调整景点顺序以减少往返
- 检查总距离和预计时间，确保行程合理

### 3. 捕获完整路线图截图 (必需)
- `take_screenshot("./routes/complete-route-map.png", fullPage=True)`

**路线图截图要求**:
- ⚠️ 必须使用Chrome DevTools MCP的 `take_screenshot` 工具
- 使用 `fullPage=True` 捕获完整的路线图
- 确保所有景点标记都在截图中可见
- 路线应清晰显示游览顺序
- 包含预计时间信息
- 此截图将作为攻略的路线概览图

### 4. 提取路线信息
- 总距离
- 预计游览时间
- 步行 vs 开车建议

### 5. 查找附近地点
对于每个景点，搜索附近的:
- 餐厅 (美食)
- 酒店 (酒店)
- 交通枢纽 (交通)

提取并在行程中包含顶级推荐。

---

## 5. 生成Markdown行程

将所有收集的信息编译成结构化的Markdown指南。

### 行程结构示例

# {目的地} {旅行天数}日行程

## 📋 行程概览
- **目的地**: {destination}
- **天数**: {days} 天
- **旅行类型**: {trip_type}
- **预估预算**: {budget}

## 🗓️ 每日行程

### 第1天

#### 上午
**{景点名称}**
- 📍 [在Google Maps上查看]({maps_link})
- 📍 地址: {full_address}
- ⭐ 评分: {rating}/5 ({review_count} 条评论)
- 💳 支付方式: {payment_method} (刷卡/现金)
- 🎫 门票: {ticket_price} (如适用)
- 📸 地点图片:
  ![{景点名称}](./maps/{location_id}.png)
- 💡 推荐: {xiaohongshu_summary}
- 📝 备注: {practical_tips}

#### 下午
**{景点名称}**
- ... (相同结构，包含地点图片)

#### 晚上
**{餐厅名称}**
- 📍 [在Google Maps上查看]({maps_link})
- 📍 地址: {full_address}
- 🍽️ 推荐菜品: {dishes}
- 💰 人均消费: {price}
- ⭐ 评分: {rating}/5 ({review_count} 条评论)
- 💳 支付方式: {payment_method} (刷卡/现金/电子支付)
- 📸 地点图片:
  ![{餐厅名称}](./maps/{restaurant_id}.png)

---

## 6. 保存到飞书 (必需步骤)

生成Markdown行程后，你**必须**将其保存到飞书云文档。

### 前提条件
- 飞书MCP工具必须可用
- 用户应具有适当权限

### 保存到飞书的步骤
1. 将Markdown导入飞书:
```python
# 使用 docx_builtin_import 工具
mcp__mcp-router__docx_builtin_import(
    data={
        "markdown": markdown_content,
        "file_name": "{destination}_{duration}day_itinerary"
    }
)
```

**必需参数**:
- `markdown`: 行程的完整markdown内容
- `file_name`: 描述性文件名（如"胡志明市一日游citywalk攻略"）
- **最大文件名长度**: 27个字符

### 处理响应
- **成功**: 文档将在用户的飞书中创建
- 保存文档URL/令牌以供将来参考
- 通知用户文档位置

### 最佳实践
- 使用包含目的地和天数的描述性文件名
- 在文件名中包含emoji以提高可见性（🇻🇳, 🍜等）
- 保持文件名在27个字符以内
- 根据用户偏好使用中文或英文

> [!IMPORTANT]
> ⚠️ 此步骤是必需的 - 不要跳过
> ⚠️ 在完成任务前务必保存到飞书
> ⚠️ 最大markdown文件大小: 20MB
> ⚠️ 图片可以嵌入但需要单独上传
> 💡 提示: 同时保存本地副本作为备份

---

## 数据处理最佳实践

### 处理名称匹配
- 小红书使用中文名称，Google Maps可能显示英文
- 搜索地点时使用模糊匹配
- ⚠️ **必须**通过 Google Maps 验证每个地点的准确性
- 通过交叉引用地址和评分进行验证
- 不确定时，向用户提供多个选项

### 去重逻辑
- 按名称相似性对相似地点进行分组
- 合并来自多篇小红书笔记的信息
- 优先考虑互动量高的地点（点赞/收藏）
- 删除低质量或不相关的条目
- ⚠️ 确保每个地点都有 Google Maps 数据支撑

### 路线优化算法 (必需)
为了确保整体路程最短，必须应用以下优化策略：

1. **地理聚类**:
   - 将景点按地理位置分组 (例如: 按行政区、街道或区域)
   - 同一区域的景点安排在同一时段游览
   - 使用Google Maps计算景点之间的实际距离
2. **最短路径规划**:
   - 使用"旅行商问题"(TSP)的近似算法
   - 优先访问地理上相邻的景点
   - 避免在同一区域往返多次
   - 考虑单行道或交通限制
3. **时间窗口约束**:
   - 考虑景点的开放时间
   - 高优先级景点安排在黄金时间
   - 避免在景点关闭时间到达
   - 为交通和游览留出缓冲时间

**优化检查清单**:
- ✅ 路线总距离是否最短?
- ✅ 是否避免了走回头路?
- ✅ 景点之间的衔接是否合理?
- ✅ 步行距离是否在可接受范围内?
- ✅ 是否考虑了交通高峰期?

### 预算估算
- 提取小红书笔记中提到的价格
- 从多个来源计算平均值
- 为意外费用增加10-20%的缓冲
- 以清晰的类别呈现预算

### Google Maps 数据要求 (必需)
- ✅ 每个景点必须有 Google Maps 链接
- ✅ 每个景点必须有评分和评论数
- ✅ 每个景点必须有完整地址
- ✅ 每个景点必须有地点图片
- ✅ 💳 每个餐厅/景点必须标注支付方式（是否可刷卡）
- ✅ 必须有完整的路线图截图
- ✅ 如果 Google Maps 找不到信息，必须在文档中标注

**支付方式标注说明**:
- 对于餐厅：必须标注是否接受信用卡/借记卡、Alipay、WeChat Pay 等
- 对于景点：必须标注是否可以刷卡购买门票，或是否只收现金
- 如果 Google Maps 没有支付方式信息，需标注"建议备现金"或"支付方式请现场确认"

---

## 错误处理

### 常见场景

- **小红书需要登录**:
  - 通知用户可能需要登录
  - 考虑现有缓存数据是否足够
  - 如需要，使用替代数据源
- **Google Maps上找不到地点**:
  - ⚠️ 这是关键步骤，必须尝试多种方法
  - 尝试简化的搜索词
  - 如果城市名称多余则删除
  - 按景点类别+地标搜索
  - 使用中英文混合搜索
  - 如果仍然找不到，使用 Web Search + Web Reader 替代方案
  - ⚠️ 在最终文档中明确标注"Google Maps 信息未找到"
- **无法提取评分或链接**:
  - 检查网络连接
  - 尝试刷新页面重新搜索
  - 使用替代的 Google Maps 搜索工具
  - 如果持续失败，记录并在文档中说明
- **页面加载缓慢**:
  - 增加 `wait_for` 超时值
  - 使用 `take_snapshot` 验证页面状态
  - 如果性能关键，考虑提取较少数据
  - 对于 Google Maps，确保等待 `.place-info` 元素加载完成
- **访问频率限制**:
  - 在搜索之间添加延迟（2-3秒）
  - 限制滚动迭代
  - 缓存结果以避免重复搜索
  - 对于 Google Maps，避免短时间内多次搜索相同地点

---

## 完整工作流程示例

1. **收集参数**: `destination="成都"`, `days=5`, `type="美食之旅"`
2. **搜索小红书**:
   - 访问小红书，搜索"成都 美食之旅 攻略"，等待结果。
3. **浏览至少10篇笔记 (必需)**:
   - 遍历至少10篇相关帖子，提取行程、地点、价格、提示。
   - → 提取至少10篇（甚至20篇）内容。
4. **处理数据**:
   - 提取所有餐厅和景点。
   - **地理聚类**并规划最优路线。
5. **整合Google Maps (必需 - 每个地点都要搜索)**:
   - 为每个地点搜索 Google Maps。
   - 提取地址、链接、评分、**支付方式**。
   - 使用 `take_screenshot` 保存地点图片。
6. **生成最优路线 (必需 - 路线优化)**:
   - 按地理邻近性分组，创建每日最优化行程。
   - 为整个行程生成 Google Maps 路线图并截图。
7. **编译Markdown**:
   - 整合所有信息，嵌入图片和地图链接。
8. **保存到飞书 (必需)**:
   - 使用飞书工具上传，确认保存成功。
   - ✅ 告知用户文档位置。

---

## 附加资源

### 参考文件
- `references/xiaohongshu-selectors.md` - DOM 选择器、JS 提取模式。
- `references/google-maps-workflows.md` - 导航、提取、截图方法。
- `references/data-extraction-patterns.md` - 清理、去重、聚类算法。
- `references/markdown-templates.md` - 详细模板。

### 示例文件
- `examples/tokyo-itinerary.md` - 东京示例。
- `examples/sichuan-food-tour.md` - 四川美食之旅示例。

### 自动化脚本
- `scripts/extract-xiaohongshu.js` - JS 提取脚本。
- `scripts/format-itinerary.py` - Python 格式化脚本。

### 验证清单 (重要)
- ✅ 触发：技能是否对旅行查询生效？
- ✅ 深度研究：是否浏览了至少10篇笔记？
- ✅ 数据丰富：每个景点是否有 Google Maps 链接、评分、地址？
- ✅ 支付信息：是否明确标注了刷卡/现金？
- ✅ 视觉化：是否有地点截图和完整路线图？
- ✅ 路径优化：路线是否最短？是否避免了回头路？
- ✅ 落地：是否成功保存到飞书？

---

> [!CAUTION]
> ⚠️ **记住**：跳过 Google Maps 搜索或截图步骤会严重降低攻略质量和实用性！未优化的路线会浪费游客大量时间和精力！
